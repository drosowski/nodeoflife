<html>
<head>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
	<script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
	<style>
		#board {
			float: left;
		}
	</style>
</head>
<body>
	<div id="board"></div>
	
	<div id="settings">
		<div>
			<label for="size">Size of the board</label>
			<input type="text" name="width" id="width" value="32">x
			<input type="text" name="height" id="height" value="32">
		</div>
		<p/>
		<input type="button" onclick="initGrid($('#width').val(), $('#height').val());" value="Resize">

		<p/>
		<div>
			<label for="size">Round time (ms)</label>
			<input type="text" name="time" id="time" value="500">
		</div>
		<p/>
		<input type="button" onclick="startGame();" value="Start">
		<input type="button" onclick="stopGame();" value="Stop">
		<input type="button" onclick="pauseGame();" value="Pause">
	</div>

        <script type="text/javascript">

	var livingCells = [];

	function startGame() {
		var width = $('#width').val(); 
		var height = $('#height').val();

		$.ajax({
			type: "GET",
			url: "startgame",
			data: { width: width, height: height, id: "{{uuid}}", livingCells: joinLivingCells() }
		});

		startGameTimer();
	}

	function startGameTimer() {
		var time = $('#time').val();
		window.gameTimer = setInterval(function() {	
				$.getJSON('population.json?id={{ uuid }}', function(population) {		
					fillGrid(population);	
					});
				}, time);
	}

	function stopGame() {
		clearInterval(window.gameTimer);
		initGrid($('#width').val(), $('#height').val());
	}

	function pauseGame() {
		if(window.gameTimer) {
			clearInterval(window.gameTimer);
			window.gameTimer = false;
		}
		else {
			startGameTimer();
		}
	}	

	function joinLivingCells() {
		var livingCellsString = "";
		for(var i = 0; i < livingCells.length; i++) {
			livingCellsString += livingCells[i].x;
			livingCellsString += ".";
			livingCellsString += livingCells[i].y;
			if(i + 1 < livingCells.length) {
				livingCellsString += "-";
			}
		}

		return livingCellsString;
	}

	function initGrid(width, height) {
		$('#board').html("");
		var grid = Raphael('board', width * 10, height * 10);

		var step = 10;
		for(var i = 0; i < height; i++) {
			for(var j = 0; j < width; j++) {
				var x = j * step;
				var y = i * step;

				var rect = grid.rect(x, y, step, step);
				rect.attr("stroke-width", 0.1)
					.data("x", j)
					.data("y", i)
					.attr("fill", "white")
					.click(function() {
						if(this.attr("fill") == "white") {
							livingCells.push({ x: this.data("x"), y: this.data("y") });
							this.attr("fill", "black");
						}
						else {
							for(var i = 0; i < livingCells.length; i++) {
								if(livingCells[i].x == this.data("x") && livingCells[i].y == this.data("y")) {
									livingCells.splice(i, 1);
								}
							}
							this.attr("fill", "white");
						}
				});
			}
		}
	}

	function fillGrid(population) {
		$('#board').html("");
		var grid = Raphael('board', width * 10, height * 10);

		var step = 10;
		for(var i = 0; i < population.length; i++) {
			for(var j = 0; j < population[i].length; j++) {
				var fill = (population[i][j] == 1);
				if(fill) {
					var rect = grid.rect(j * step, i * step, step, step)
						.attr("stroke-width", 0.1)
						.attr("fill", "black");
				}
				else {
					var rect = grid.rect(j * step, i * step, step, step)
						.attr("stroke-width", 0.1)
						.attr("fill", "white");
				}
			}
		}
	}

	$(document).ready(function() {
		initGrid($('#width').val(), $('#height').val());
	});
	</script>
</body>
</html>
